function generateGrid() {
  const e = document.getElementById("userInput").value,
    t = document.getElementById("timeRange").value,
    a = document.getElementById("gridSize").value,
    o = document.getElementById("showAlbumName").checked,
    l = document.getElementById("showAlbumPlaycount").checked,
    s = "albums",
    n = document.getElementById("albumGrid");
  let i = 18,
    d = "";
  switch (
    ("albums" === s
      ? (d = "user.getTopAlbums")
      : "artists" === s && (d = "user.getTopArtists"),
    a)
  ) {
    case "3":
      (i = 18), (placeY = 18);
      break;
    case "4":
      (i = 16), (placeY = 16);
      break;
    case "5":
      (i = 14), (placeY = 14);
      break;
    case "6":
      (i = 12), (placeY = 12);
      break;
    case "7":
      (i = 12), (placeY = 10);
  }
  let r = `https://ws.audioscrobbler.com/2.0/?method=${d}&user=${e}&period=${t}&api_key=e713e4ee81e3cfee0417956233a9faa1&format=json`;
  fetch(r)
    .then((e) => e.json())
    .then((e) => {
      const t = a * a,
        d = document.createElement("canvas");
      (d.width = 1250), (d.height = 1250);
      const r = d.getContext("2d");
      let c = 0;
      const h = () => {
        if ((c++, c === t)) {
          const e = document.createElement("img");
          (e.src = d.toDataURL()),
            (e.alt =
              "albums" === s
                ? "Generated Album Grid"
                : "Generated Artist Grid"),
            (e.className = "generated-image"),
            (n.innerHTML = ""),
            n.appendChild(e);
          const t = document.getElementById("downloadButton");
          t.style.display = "block";
        }
      };
      if ("albums" === s) {
        const s = e.topalbums.album.slice(0, t);
        s.forEach((e, t) => {
          const s = new Image();
          (s.src = e.image[3]["#text"]),
            (s.crossOrigin = "Anonymous"),
            (s.onload = function () {
              const n = (t % a) * (d.width / a),
                c = Math.floor(t / a) * (d.height / a);
              if ((r.drawImage(s, n, c, d.width / a, d.height / a), o)) {
                (r.font = `${i}px Fira Sans`),
                  (r.shadowColor = "#2b2b2b"),
                  (r.shadowBlur = 0.3),
                  (r.shadowOffsetX = 1),
                  (r.shadowOffsetY = 1),
                  (r.fillStyle = "white"),
                  r.fillText(e.artist.name, n + 2, c + placeY);
                const t = `${e.artist.name} - ${e.name}`,
                  a = r.measureText(t).width;
                if (a > s.width) {
                  const e = s.width / a,
                    t = i * e;
                  r.font = `${t}px Fira Sans`;
                }
                r.fillText(e.name, n + 2, c + (placeY + 16));
              }
              l &&
                ((r.font = `${i}px Fira Sans`),
                (r.shadowColor = "#2b2b2b"),
                (r.shadowBlur = 0.3),
                (r.shadowOffsetX = 1),
                (r.shadowOffsetY = 1),
                (r.fillStyle = "white"),
                r.fillText(`Plays: ${e.playcount}`, n + 2, c + (placeY + 32))),
                h();
            }),
            (s.onerror = function () {
              const s = (t % a) * (d.width / a),
                n = Math.floor(t / a) * (d.height / a);
              (r.fillStyle = "black"),
                r.fillRect(s, n, d.width / a, d.height / a),
                o &&
                  ((r.font = `${i}px Fira Sans`),
                  (r.shadowColor = "#2b2b2b"),
                  (r.shadowBlur = 0.3),
                  (r.shadowOffsetX = 1),
                  (r.shadowOffsetY = 1),
                  (r.fillStyle = "white"),
                  r.fillText(e.artist.name, s + 2, n + placeY),
                  r.fillText(e.name, s + 2, n + (placeY + 16))),
                l &&
                  ((r.font = `${i}px Fira Sans`),
                  (r.shadowColor = "#2b2b2b"),
                  (r.shadowBlur = 0.3),
                  (r.shadowOffsetX = 1),
                  (r.shadowOffsetY = 1),
                  (r.fillStyle = "white"),
                  r.fillText(
                    `Plays: ${e.playcount}`,
                    s + 2,
                    n + (placeY + 32)
                  )),
                h();
            });
        });
      } else if ("artists" === s) {
        const s = e.topartists.artist.slice(0, t);
        s.forEach((e, t) => {
          const s = new Image();
          (s.src = e.image[3]["#text"]),
            (s.crossOrigin = "Anonymous"),
            (s.onload = function () {
              const n = (t % a) * (d.width / a),
                i = Math.floor(t / a) * (d.height / a);
              r.drawImage(s, n, i, d.width / a, d.height / a),
                o &&
                  ((r.font = "18px Arial"),
                  (r.shadowColor = "#2b2b2b"),
                  (r.shadowBlur = 5),
                  (r.shadowOffsetX = 2),
                  (r.shadowOffsetY = 2),
                  (r.fillStyle = "white"),
                  r.fillText(e.name, n + 5, i + 20)),
                l &&
                  ((r.font = "18px Arial"),
                  (r.shadowColor = "#2b2b2b"),
                  (r.shadowBlur = 5),
                  (r.shadowOffsetX = 2),
                  (r.shadowOffsetY = 2),
                  (r.fillStyle = "white"),
                  r.fillText(`Plays: ${e.playcount}`, n + 5, i + 40)),
                h();
            }),
            (s.onerror = function () {
              const e = (t % a) * (d.width / a),
                o = Math.floor(t / a) * (d.height / a);
              (r.fillStyle = "black"),
                r.fillRect(e, o, d.width / a, d.height / a),
                h();
            });
        });
      }
    })
    .catch((e) => {
      console.error("Erro ao obter os dados do Last.fm:", e),
        alert(
          "Erro ao obter os dados do Last.fm. Verifique o nome de usu√°rio e tente novamente."
        );
    });
}
function downloadGrid() {
  const e = document.querySelector(".generated-image");
  if (e) {
    const t = document.createElement("a");
    (t.href = e.src),
      (t.download = "semaninha.png"),
      document.body.appendChild(t),
      t.click(),
      document.body.removeChild(t);
  } else alert("Sem imagem para baixar!");
}
