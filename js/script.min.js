var style = document.createElement("style"),
  fonteFiraSans = new FontFace("Fira Sans", 'url("./FiraSans-Italic.ttf")');
function generateGrid() {
  let e = document.getElementById("userInput").value,
    t = document.getElementById("timeRange").value,
    a = document.getElementById("gridSize").value,
    l = document.getElementById("showAlbumName").checked,
    o = document.getElementById("showAlbumPlaycount").checked,
    s = "albums",
    i = document.getElementById("albumGrid"),
    r = 18,
    n = "";
  switch (
    ("albums" === s
      ? (n = "user.getTopAlbums")
      : "artists" === s && (n = "user.getTopArtists"),
    a)
  ) {
    case "3":
      (r = 18), (placeY = 18);
      break;
    case "4":
      (r = 16), (placeY = 16);
      break;
    case "5":
      (r = 14), (placeY = 14);
      break;
    case "6":
      (r = 12), (placeY = 12);
      break;
    case "7":
      (r = 12), (placeY = 10);
  }
  fetch(
    `https://ws.audioscrobbler.com/2.0/?method=${n}&user=${e}&period=${t}&api_key=e713e4ee81e3cfee0417956233a9faa1&format=json`
  )
    .then((e) => e.json())
    .then((e) => {
      let t = a * a,
        n = document.createElement("canvas");
      (n.width = 1250), (n.height = 1250);
      let d = n.getContext("2d"),
        f = 0,
        h = () => {
          if (++f === t) {
            let e = document.createElement("img");
            (e.src = n.toDataURL()),
              (e.alt =
                "albums" === s
                  ? "Generated Album Grid"
                  : "Generated Artist Grid"),
              (e.className = "generated-image"),
              (i.innerHTML = ""),
              i.appendChild(e);
            let a = document.getElementById("downloadButton");
            a.style.display = "block";
          }
        };
      if ("albums" === s) {
        let m = e.topalbums.album.slice(0, t);
        m.forEach((e, t) => {
          let s = new Image();
          (s.src = e.image[3]["#text"]),
            (s.crossOrigin = "Anonymous"),
            (s.onload = function () {
              let i = (t % a) * (n.width / a),
                f = Math.floor(t / a) * (n.height / a);
              if ((d.drawImage(s, i, f, n.width / a, n.height / a), l)) {
                (d.font = `${r}px Fira Sans`),
                  (d.shadowColor = "#2b2b2b"),
                  (d.shadowBlur = 0.3),
                  (d.shadowOffsetX = 1),
                  (d.shadowOffsetY = 1),
                  (d.fillStyle = "white"),
                  d.fillText(e.artist.name, i + 2, f + placeY);
                let m = `${e.artist.name} - ${e.name}`,
                  c = d.measureText(m).width;
                if (c > s.width) {
                  let w = s.width / c,
                    u = r * w;
                  d.font = `${u}px Fira Sans`;
                }
                d.fillText(e.name, i + 2, f + (placeY + 16));
              }
              o &&
                ((d.font = `${r}px Fira Sans`),
                (d.shadowColor = "#2b2b2b"),
                (d.shadowBlur = 0.3),
                (d.shadowOffsetX = 1),
                (d.shadowOffsetY = 1),
                (d.fillStyle = "white"),
                d.fillText(`Plays: ${e.playcount}`, i + 2, f + (placeY + 32))),
                h();
            }),
            (s.onerror = function () {
              let s = (t % a) * (n.width / a),
                i = Math.floor(t / a) * (n.height / a);
              (d.fillStyle = "black"),
                d.fillRect(s, i, n.width / a, n.height / a),
                l &&
                  ((d.font = `${r}px Fira Sans`),
                  (d.shadowColor = "#2b2b2b"),
                  (d.shadowBlur = 0.3),
                  (d.shadowOffsetX = 1),
                  (d.shadowOffsetY = 1),
                  (d.fillStyle = "white"),
                  d.fillText(e.artist.name, s + 2, i + placeY),
                  d.fillText(e.name, s + 2, i + (placeY + 16))),
                o &&
                  ((d.font = `${r}px Fira Sans`),
                  (d.shadowColor = "#2b2b2b"),
                  (d.shadowBlur = 0.3),
                  (d.shadowOffsetX = 1),
                  (d.shadowOffsetY = 1),
                  (d.fillStyle = "white"),
                  d.fillText(
                    `Plays: ${e.playcount}`,
                    s + 2,
                    i + (placeY + 32)
                  )),
                h();
            });
        });
      } else if ("artists" === s) {
        let c = e.topartists.artist.slice(0, t);
        c.forEach((e, t) => {
          let s = new Image();
          (s.src = e.image[3]["#text"]),
            (s.crossOrigin = "Anonymous"),
            (s.onload = function () {
              let i = (t % a) * (n.width / a),
                r = Math.floor(t / a) * (n.height / a);
              d.drawImage(s, i, r, n.width / a, n.height / a),
                l &&
                  ((d.font = "18px Fira Sans"),
                  (d.shadowColor = "#2b2b2b"),
                  (d.shadowBlur = 5),
                  (d.shadowOffsetX = 2),
                  (d.shadowOffsetY = 2),
                  (d.fillStyle = "white"),
                  d.fillText(e.name, i + 5, r + 20)),
                o &&
                  ((d.font = "18px Fira Sans"),
                  (d.shadowColor = "#2b2b2b"),
                  (d.shadowBlur = 5),
                  (d.shadowOffsetX = 2),
                  (d.shadowOffsetY = 2),
                  (d.fillStyle = "white"),
                  d.fillText(`Plays: ${e.playcount}`, i + 5, r + 40)),
                h();
            }),
            (s.onerror = function () {
              let e = (t % a) * (n.width / a),
                l = Math.floor(t / a) * (n.height / a);
              (d.fillStyle = "black"),
                d.fillRect(e, l, n.width / a, n.height / a),
                h();
            });
        });
      }
    })
    .catch((e) => {
      console.error("Erro ao obter os dados do Last.fm:", e),
        alert(
          "Erro ao obter os dados do Last.fm. Verifique o nome de usu\xe1rio e tente novamente."
        );
    });
}
function downloadGrid() {
  let e = document.querySelector(".generated-image");
  if (e) {
    let t = document.createElement("a");
    (t.href = e.src),
      (t.download = "semaninha.png"),
      document.body.appendChild(t),
      t.click(),
      document.body.removeChild(t);
  } else alert("Sem imagem para baixar!");
}
fonteFiraSans.load().then(function (e) {
  document.fonts.add(e),
    style.appendChild(
      document.createTextNode(`
    @font-face {
      font-family: 'Fira Sans';
      src: url('./FiraSans-Italic.ttf') format('truetype');
    }
  `)
    ),
    document.head.appendChild(style);
});
